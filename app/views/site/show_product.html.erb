<% content_for :customer_title do %>
  商城
<% end %>
<style type="text/css">
  body {
    overflow-x: hidden;
    margin-top: -20px;
  }
  /* 顶部商品图片 */
  .top-img {
    width: 100%;
    height: 320px;
    text-align: center;
  }

  .top-img img {
    height: 320px;
    width: 250px;
    vertical-align: middle;
  }

  /* 商品名称、价格、运费相关信息 */
  .p-charge {
    padding: 0 20px;
    color: #787878;
    margin: 0 auto;
  }

  .p-charge > div{
    padding:0 ;
    margin: 0 auto;
  }

  .p-charge>div:first-child>span:first-child,.p-charge .freight{
    font-size: 18px;
  }

  .p-charge>div  span{
    margin-right: 2px;
    text-align: justify;
  }

  .p-charge>div:first-child>span:nth-child(2){
    font-size: 12px;
  }

  .p-charge .price {
    color: #f06200;
    font-size: 30px;
  }

  /* 商品数量添加、减少 */
  .p-ampunt {
    height: 35px;
    padding: 0;
    clear: both;
    width: 100%;
    color: #787878;
  }

  .p-ampunt div {
    float: left;
    vertical-align: middle;
    line-height: 30px;
    height: 30px;
  }

  .p-ampunt div:first-child{
    margin-left: 20px;
  }

  .ampunt-action  button , .ampunt-action .p-num{
    border-style: solid;
    border-color: #dfdfdf;
    height: 30px;
    float: left;
    line-height: 30px;
  }

  .ampunt-action button{
    width: 30px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    margin: 0;
    padding: 0;
    background-color: #dfdfdf;
  }

  .ampunt-action .p-num{
    margin: 0;
    padding: 0;
    border-width: 0;
    width: 50px;
    text-align: center;
    color: #787878;
  }

  .ampunt-action .action-de{
    border-width: 1px 0 1px 1px;
    border-radius: 5px 0 0 5px;
  }

  .ampunt-action .action-plus{
    border-width: 1px 1px 1px 0;
    border-radius: 0 5px 5px 0;
  }

  /* 加入购物车和立即购买按钮 */
  .p-purchase {
    position: relative;
    height: 60px;
    padding: 0 10px;
    clear: both;
  }
  .p-purchase button {
    float: left;
    width: 30%;
    height: 35px;
    line-height: 35px;
    font-size: 14px;
    vertical-align: middle;
    color: #787878;
  }

  .p-purchase .btn-add {
    background-color: #f0ad4e;
    border-color: #f0ad4e;
    border-radius: 5px;
    color: #fff;
  }

  .p-purchase .btn-red {
    color: #fff;
  }

  .buy-now {
    background-color: #f0ad4e;
    border-color: #f0ad4e;
  }

  /* 分享按钮 */
  #share > button {
    font-size: 14px;
    height: 35px;
    line-height: 35px;
    vertical-align: middle;
    width: 78%;
    margin: 0 auto;
    text-align: cetner;
    display: block;
    background-color: #d9534f;
    border-color: #d9543f;
  }

  /* 点击分享按钮后的弹出框 */
  .back {
    z-index: 11;
    position: fixed;
    *position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: #000;
    opacity: 0.5;
    filter: alpha(opacity=50);
    -moz-opacity: 0.5;
    display: none;
  }
  .share_notice {
    display: none;
    position: fixed;
    *position: absolute;
    top: 30%;
    left: 50%;
    width: 80%;
    height: 200px;
    margin-top: -100px;
    margin-left: -40%;
    background-color: #fff;
    border-radius: 5px;
    padding-bottom: 35px;
    color: #666;
    z-index: 100;
    box-shadow: 0 0 3px #666;
  }
  .share_notice > img {
    width: 90%;
    height: 180px;
  }
  .share_notice > p {
    text-align: center;
    font-weight: bold;
    font-size: 24px;
  }

  /* 商品评论链接 */
  .p-comments {
    padding: 0 20px;
    height: 40px;
    clear: both;
  }

  .p-comments p {
    width: 100%;
    line-height: 30px;
    height: 30px;
    color: #787878;
  }

  .p-comments .comment-count {
    background-color: #5cb75c;
    border-radius: 3px;
    width: 15px;
    text-align: center;
    color: #fff;
  }

  .arrow {
    float: right;
    font-size: 20px;
  }

  /* 商品评价信息 */
  .p-intro {
    height: auto;
    clear: both;
    min-height: 150px;
    margin-bottom: 70px;
    width: 100%;
  }
  .desc > * {
    width: 96%;
    margin: 0 auto;
    word-break: nowrap;
  }
  .desc img {
    width: 100%;
    margin: 0 auto;
  }
  .p-intro h4{
    color: #787878;
    font-weight: normal;
    margin-left: 20px;
  }
  .p-intro p {
    font-size: 16px;
    font-weight: normal;
  }
  .p-intro div {
    word-wrap: break-word;
  }
  .p-intro .name{
    color: #f06200;
    margin:  0;
    padding: 0;
  }
</style>
<div class="main">
  <!-- 顶部商品图片 -->
  <input class="product-id" type="hidden" value="<%= @product.id %>">
  <div class="top-img"><img src="<%= @product.img_url %>"/></div>
  <hr/>

  <!-- 商品名称、价格、运费信息 -->
  <div class="p-charge">
    <div>
      <span class="product-name"><%= @product.name %></span>
      <span class="product-englishname"><%= @product.name %></span>
    </div>
    <div>
      <span class="price">¥ <%= @product.price %>元</span>
      <span class="freight">&nbsp;&nbsp;&nbsp;&nbsp;运费: ¥ <span class="freight-price"><% if @product.fright %><%= @product.fright %><% else %>0<% end %></span>元</span>
    </div>
  </div>
  <hr/>
  <!-- 商品数量 -->
  <div class="p-ampunt">
    <div>数量:&nbsp;&nbsp;</div>
    <div class="ampunt-action">
      <button class="action-de" type="button">-</button>
      <input type="text" name="p-num" class="p-num" value="1">
      <button class="action-plus" type="button">+</button>
    </div>
  </div>
  <hr/>
  <div class="p-purchase" data-no-turbolink>
    <button id="input-shoppingcart" class="btn btn-add" type="button">加入购物车</button>
    <button class="buy-now btn btn-red" type="button">立即购买</button>
  </div>
  <div id="share">
    <button type="button" class='share btn btn-red'>分享获取提成</button>
  </div>
  <hr/>
  <!-- 商品评论链接 -->
  <div class="p-comments">
    <a href="/customer/products/<%= @product.id %>/comments">
      <p>商品评论&nbsp;&nbsp;<span class="comment-count">&nbsp;&nbsp;&nbsp;&nbsp;<%= @product.comment_threads.size %>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="arrow">&gt;</span>
      </p>
    </a>
  </div>
  <hr/>

  <!-- 商品评价相关信息 -->
  <div class="p-intro">
    <h4>商品详情</h4>
    <div class="desc"><%= raw @product.description %></div>
  </div>

  <!-- 分享弹出框 -->
  <div class="share_notice">
    <img src="/zhonglian/img/share.png" />
    <p>分享可获提成</p>
  </div>
  <div class="back"></div>
</div>
<script type="text/javascript" src="/zhonglian/js/jquery-1.7.2.js"></script>
<script src="/zhonglian/js/show_product.js"></script>
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script>
var jQuery_1_7_2 = $.noConflict(true);
</script>
<script type="text/javascript">
  jQuery(document).ready(function($) {
    // 点击分享按钮，弹出引导框
    $( '.share' ).on( 'click', function() {
      $( '.back' ).show();
      $( '.share_notice' ).slideDown(800);
      setTimeout( function() {
        $( '.back' ).hide();
        $( '.share_notice' ).slideUp(800);
      },3000);
    });

    // 商品数量的加减
    var minus = $(".action-de");
    var plus = $(".action-plus");
    var numInput = $(".p-num");
    var num = 0;
    plus.on('click', function() {
      num = parseInt(numInput.val());
      num++;
      numInput.val(num);
    });
    minus.on('click', function() {
      if (num > 1) {
        num--;
        numInput.val(num);
      } else {
        numInput.val(1);
        alert("购物数量不能为0")
      }
    });

    // 若直接输入商品数量，也得判断
    numInput.on( "blur", function() {
      if( numInput.val() == '' || numInput.val() <= 0 || isNaN( numInput.val() ) ) {
          alert( "请输入正确的商品数量！" );
          numInput.focus();
      }
    });

    // 判断是否为微信内置浏览器函数
    function isWechat(){
      var ua = navigator.userAgent.toLowerCase();
      if(ua.match( /MicroMessenger/i )=="micromessenger") {
        return true;
      } else {
        return false;
      }
    }

    // 微信分享的相关设置参数
    var hostname = location.hostname;
    var port = location.port;
    var domain = "http://" + hostname + ':' + port;
    var desc = $( '.desc' ).text();
    var img_url = domain + "<%= @product.img_url %>";
    var link = domain + "/customer/products/<%= @product.id %>/show?share_link_code=<%= current_user.profile.share_link_code if current_user %>"

    // 若为微信内置浏览器，才进行各种操作
    var share_param = $.url().param( "share_link_code" );
    if ( share_param ) {
      alert("worked");
      var appid = '<%= @share_hash[:app_id] %>';
      var timestamp= '<%= @share_hash[:timestamp] %>';
      var noncestr = '<%= @share_hash[:noncestr] %>';
      var signature = '<%= @share_hash[:signature] %>';
      // 接口权限配置
      wx.config({
        debug: true,
        appId: appid,
        timestamp: timestamp,
        nonceStr: noncestr,
        signature: signature,
        jsApiList: ['onMenuShareAppMessage','onMenuShareTimeLine','onMenuShareWeibo','onMenuShareQQ']
        });

      // 信息验证成功
      wx.ready(function(){

        // 分享给朋友
        wx.onMenuShareAppMessage({
          title: '诚邀您加入众联酒业微信商城',
          desc: desc,
          link: link,
          imgUrl: img_url,
          type: 'link',
          success: function () {
            alert(link);
          },
          cancel: function () {
              alert('cancel');
          }
        });

        // 分享到朋友圈
        wx.onMenuShareTimeline({
          title: '诚邀您加入众联酒业微信商城',
          link: link,
          imgUrl: img_url,
          success: function () {
            alert(url);
          },
          cancel: function () {
              alert('cancel')
          }
        });

        // 分享到腾讯微博
        wx.onMenuShareWeibo({
          title: '诚邀您加入众联酒业微信商城',
          desc: desc,
          link: link,
          imgUrl: img_url,
          success: function () {
            alert(url);
          },
          cancel: function () {
            alert('cancel')
          }
        });

        // 分享到QQ
        wx.onMenuShareQQ({
          title: '诚邀您加入众联酒业微信商城',
          desc: desc,
          link: link,
          imgUrl: img_url,
          success: function () {
            alert(url);
          },
          cancel: function () {
            alert('cancel')
          }
        });

      });

      // 信息验证失败
      wx.error(function( res ){
        alert(res.errMsg);
      });
    }
  });
</script>
<%= render "site/shared/bottombar" %>
